# -*- coding: utf-8 -*-
"""Chatbot2.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1ddZ3NdGcCSru0YBxzbPg8cDI_VnUxebJ
"""

import streamlit as st
import time

# ----------------------------------------------------
# ğŸ¨ ESTILOS PERSONALIZADOS PREMIUM + AVATARES
# ----------------------------------------------------
st.markdown("""
    <style>

    body, .stApp {
        background-color: #f3e9dd !important;
        background-image: radial-gradient(circle at top left, #f7f0e7, #e9dcc5);
        background-attachment: fixed;
    }

    .title-container h1 {
        color: #4b2e19 !important;
        font-family: 'Segoe UI', sans-serif;
        font-weight: 700;
    }

    .user-bubble {
        background: #ffffff !important;
        padding: 12px 18px;
        border-radius: 18px;
        margin: 10px 0;
        border: 2px solid #d7c7b5;
        color: #3b2a1e;
        font-size: 16px;
        display: inline-block;
        animation: fadeIn 0.4s ease;
    }

    .bot-bubble {
        background: #f0e6d9 !important;
        padding: 12px 18px;
        border-radius: 18px;
        margin: 10px 0;
        border: 2px solid #c6b39d;
        color: #3b2a1e;
        font-size: 16px;
        display: inline-block;
        animation: fadeIn 0.4s ease;
    }

    @keyframes fadeIn {
        from {opacity: 0; transform: translateY(5px);}
        to {opacity: 1; transform: translateY(0);}
    }

    input {
        background: #fffaf3 !important;
        border-radius: 12px !important;
        border: 2px solid #c4a98a !important;
        color: #4a3524 !important;
    }

    input:focus {
        border: 2px solid #8b5e34 !important;
        box-shadow: 0 0 6px #c2a37a !important;
    }

    button {
        background: #8b5e34 !important;
        color: white !important;
        border-radius: 10px !important;
        padding: 8px 16px !important;
        border: none !important;
    }

    button:hover {
        background: #704a28 !important;
    }

    </style>
""", unsafe_allow_html=True)


# ----------------------------------------------------
# ğŸ’° CatÃ¡logo de productos
# ----------------------------------------------------
catalogo_productos = {
    "cafÃ©": [
        {"nombre": "CafÃ© Solo", "precio": 1200},
        {"nombre": "CafÃ© Doble", "precio": 1500},
        {"nombre": "CafÃ© con Leche", "precio": 1600},
        {"nombre": "Capuchino", "precio": 2000},
        {"nombre": "Latte", "precio": 2100},
    ],
    "tÃ©": [
        {"nombre": "TÃ© ClÃ¡sico Negro", "precio": 1100},
        {"nombre": "TÃ© Verde", "precio": 1200},
        {"nombre": "TÃ© con Leche", "precio": 1300},
        {"nombre": "TÃ© de Manzanilla", "precio": 1200},
    ]
}


# ----------------------------------------------------
# ğŸ§  MODELO LLM SIN SABOR NI INTENSIDAD
# ----------------------------------------------------
class RecomendadorLLM:
    def __init__(self):
        self.estado = "inicio"
        self.tipo_seleccionado = None

    def _call(self, prompt: str) -> str:
        texto = prompt.lower().strip()

        # INICIO
        if self.estado == "inicio":
            self.estado = "tipo_bebida"
            return "ğŸ‘‹ Â¡Hola! Bienvenido/a soy tu Asistente virtual. Â¿QuerÃ©s cafÃ© o tÃ© hoy?"

        # ELEGIR CAFE O TE
        elif self.estado == "tipo_bebida":
            if "cafÃ©" in texto or "cafe" in texto:
                self.tipo_seleccionado = "cafÃ©"
                self.estado = "mostrar_menu"
                return "Perfecto â˜• Te muestro nuestra carta de cafÃ©s:"

            elif "tÃ©" in texto or "te" in texto:
                self.tipo_seleccionado = "tÃ©"
                self.estado = "mostrar_menu"
                return "Genial ğŸµ Te muestro nuestra carta de tÃ©s:"

            return "Decime si preferÃ­s *cafÃ©* o *tÃ©*."

        # ESPERA QUE EL USUARIO ELIJA DESDE LA CARTA
        elif self.estado == "mostrar_menu":
            return "ElegÃ­ tu bebida tocando un botÃ³n en la carta. ğŸ˜„"

        # CONFIRMAR COMPRA
        elif self.estado == "confirmar_compra":
            if "si" in texto or "sÃ­" in texto or "comprar" in texto:
                self.estado = "inicio"
                return (
                    "ğŸ‰ Â¡Gracias por tu compra! En minutos estarÃ¡ listo tu pedido.\n"
                    "ğŸ”„ Reiniciando asistente..."
                )
            elif "no" in texto:
                self.estado = "inicio"
                return "Todo bien ğŸ˜Š Si querÃ©s otra recomendaciÃ³n, escribime."
            return "Decime *sÃ­* para comprar o *no* para cancelar."

        return "No entendÃ­, Â¿podÃ©s repetirlo?"


# ----------------------------------------------------
# ğŸŒŸ CHAT STREAMLIT CON AVATARES
# ----------------------------------------------------
st.set_page_config(page_title="CafÃ© Premium", page_icon="â˜•")
st.title("â˜• Asistente de CafÃ© / TÃ©")

avatar_bot = "https://cdn-icons-png.flaticon.com/512/4712/4712100.png"
avatar_user = "https://cdn-icons-png.flaticon.com/512/747/747376.png"

# Estados del chat
if "messages" not in st.session_state:
    st.session_state.messages = []

if "llm" not in st.session_state:
    st.session_state.llm = RecomendadorLLM()


# Mostrar historial
for msg in st.session_state.messages:
    with st.chat_message(msg["role"], avatar=avatar_bot if msg["role"] == "assistant" else avatar_user):
        st.write(msg["content"])


# Entrada usuario
user_input = st.chat_input("EscribÃ­ tu pedido...")

if user_input:
    # Mensaje del usuario
    st.session_state.messages.append({"role": "user", "content": user_input})
    with st.chat_message("user", avatar=avatar_user):
        st.write(user_input)

    # Respuesta del bot
    respuesta = st.session_state.llm._call(user_input)
    st.session_state.messages.append({"role": "assistant", "content": respuesta})

    with st.chat_message("assistant", avatar=avatar_bot):
        st.write(respuesta)

    # Reinicio automÃ¡tico
    if "Gracias por tu compra" in respuesta:
        time.sleep(5)
        st.session_state.messages = []
        st.session_state.llm = RecomendadorLLM()
        st.rerun()


# ----------------------------------------------------
# ğŸ“œ MOSTRAR CARTA CUANDO CORRESPONDA
# ----------------------------------------------------
if st.session_state.llm.estado == "mostrar_menu":
    tipo = st.session_state.llm.tipo_seleccionado
    productos = catalogo_productos[tipo]

    st.markdown("### ğŸ“œ Carta de " + tipo.capitalize())

    cols = st.columns(2)

    for i, p in enumerate(productos):
        with cols[i % 2]:
            if st.button(f"{p['nombre']} - ${p['precio']}"):
                st.session_state.producto_seleccionado = p
                st.session_state.llm.estado = "confirmar_compra"

                mensaje = (
                    f"Elegiste **{p['nombre']}** â˜•\n"
                    f"Precio: ${p['precio']}\n\n"
                    "Â¿QuerÃ©s comprarlo?"
                )

                st.session_state.messages.append({"role": "assistant", "content": mensaje})
                st.rerun()